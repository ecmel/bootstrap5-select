{"version":3,"file":"select.js","sources":["../select.ts"],"sourcesContent":["import { Dropdown } from \"bootstrap\";\n\nexport class Select {\n  private static map = new WeakMap<Element, Select>();\n\n  static getInstance(el: Element) {\n    return this.map.get(el);\n  }\n\n  static getOrCreateInstance(el: Element) {\n    let instance = this.map.get(el);\n\n    if (!instance) {\n      instance = new Select(el);\n      this.map.set(el, instance);\n    }\n\n    return instance;\n  }\n\n  declare readonly value: string;\n  private element: HTMLElement;\n  private input: HTMLInputElement;\n  private select: HTMLSelectElement;\n  private menu: HTMLElement;\n  private list: HTMLDataListElement;\n  private dropdown: Dropdown;\n  private mutable = false;\n  private count = 0;\n\n  constructor(element: Element) {\n    this.element = element as HTMLElement;\n    this.input = this.element.querySelector(\"input\");\n    this.select = this.element.querySelector(\"select\");\n    this.menu = this.element.querySelector(\".dropdown-menu\");\n    this.dropdown = Dropdown.getOrCreateInstance(this.input);\n\n    this.input.autocomplete = \"off\";\n\n    this.mutable =\n      this.element.dataset.mutable === \"\" ||\n      this.element.dataset.mutable === \"true\";\n\n    const list = this.element.dataset.list;\n\n    if (list) {\n      this.list = document.getElementById(list) as HTMLDataListElement;\n    }\n\n    Object.defineProperty(this.element, \"value\", { get: this.getValue });\n\n    this.input.addEventListener(\"keydown\", this.onKeyDown);\n    this.input.addEventListener(\"input\", this.debounce(this.onInput));\n    this.input.addEventListener(\"focusin\", this.onFocusIn);\n    this.input.addEventListener(\"focusout\", this.onFocusOut);\n    this.input.addEventListener(\"show.bs.dropdown\", this.onShowBsDropdown);\n    this.input.addEventListener(\"shown.bs.dropdown\", this.onShownBsDropdown);\n    this.element.addEventListener(\"click\", this.onClick);\n\n    Select.map.set(this.element, this);\n\n    this.update();\n  }\n\n  update() {\n    this.element\n      .querySelectorAll(\".option\")\n      .forEach((el) => this.removeTag(el));\n\n    for (const option of this.select.selectedOptions) {\n      this.addTag(option.label, option.value);\n    }\n  }\n\n  private addTag(label: string, value = \"\") {\n    const tag = document.createElement(\"span\");\n\n    tag.classList.add(\"option\");\n\n    tag.innerText = label;\n    tag.dataset.label = label;\n    tag.dataset.value = value || label;\n\n    this.count++;\n    this.element.insertBefore(tag, this.input);\n  }\n\n  private removeTag(tag: Element) {\n    this.count--;\n    tag.remove();\n  }\n\n  private resetInput() {\n    this.input.value = \"\";\n    this.menu.replaceChildren();\n  }\n\n  private dispatchChanged() {\n    this.element.dispatchEvent(new CustomEvent(\"changed.bs5.select\"));\n    this.element.dispatchEvent(new CustomEvent(\"input\"));\n  }\n\n  private normalize(value: string) {\n    return value\n      .trim()\n      .toUpperCase()\n      .normalize(\"NFD\")\n      .replace(/[\\u0300-\\u036f]/g, \"\");\n  }\n\n  private setSelected(value: string, selected = true) {\n    let option = Array.from(this.select.options).find(\n      (option) => option.value === value\n    );\n\n    if (!option && this.list) {\n      const found = Array.from(this.list.options).find(\n        (option) => option.value === value\n      );\n\n      option = found.cloneNode(true) as HTMLOptionElement;\n\n      this.select.options.add(option);\n    }\n\n    option.selected = selected;\n  }\n\n  private addItem() {\n    const active = this.getActive();\n\n    if (active) {\n      const label = active.dataset.label;\n      const value = active.dataset.value;\n\n      this.addTag(label, value);\n      this.setSelected(value);\n    } else if (this.mutable) {\n      const value = this.input.value;\n\n      const found = Array.from(this.select.options).find(\n        (option) => option.value.trim() === value.trim()\n      );\n\n      if (found) {\n        if (!found.selected) {\n          this.addTag(value);\n          this.setSelected(value);\n        }\n      } else {\n        const option = document.createElement(\"option\");\n\n        option.value = value;\n        option.label = value;\n\n        this.select.options.add(option);\n\n        this.addTag(value);\n        this.setSelected(value);\n      }\n    }\n\n    this.dispatchChanged();\n    this.resetInput();\n\n    this.dropdown.hide();\n  }\n\n  private removeItem() {\n    const tag = this.input.previousElementSibling as HTMLElement;\n\n    if (tag) {\n      this.removeTag(tag);\n      this.setSelected(tag.dataset.value, false);\n      this.dispatchChanged();\n    }\n  }\n\n  private nextItem(backward = false) {\n    const active = this.getActive();\n\n    if (active) {\n      active.classList.remove(\"active\");\n\n      const next = backward\n        ? active.previousElementSibling\n        : active.nextElementSibling;\n\n      if (next) {\n        next.classList.add(\"active\");\n        next.scrollIntoView({ block: \"nearest\" });\n        return;\n      }\n    }\n\n    const next = backward\n      ? this.menu.lastElementChild\n      : this.menu.firstElementChild;\n\n    if (next) {\n      next.classList.add(\"active\");\n      next.scrollIntoView({ block: \"nearest\" });\n    }\n  }\n\n  private getActive(): HTMLElement {\n    return this.menu.querySelector(\".active\");\n  }\n\n  private debounce(cb: Function, delay = 250) {\n    let timeout: any;\n\n    return (...args: any[]) => {\n      clearTimeout(timeout);\n      timeout = setTimeout(() => cb(...args), delay);\n    };\n  }\n\n  private getValue = () => {\n    return this.count === 0 ? \"\" : this.count.toString();\n  };\n\n  private onClick = () => {\n    this.input.focus();\n  };\n\n  private onKeyDown = (event: KeyboardEvent) => {\n    switch (event.key) {\n      case \"Enter\":\n        if (this.input.value.length !== 0) {\n          event.preventDefault();\n          this.addItem();\n        }\n        break;\n\n      case \"Backspace\":\n        if (this.input.value.length === 0) {\n          this.removeItem();\n        }\n        break;\n\n      case \"ArrowDown\":\n        this.nextItem();\n        break;\n\n      case \"ArrowUp\":\n        this.nextItem(true);\n        break;\n    }\n  };\n\n  private onFocusIn = () => {\n    this.element.classList.add(\"focus\");\n  };\n\n  private onFocusOut = () => {\n    this.element.classList.remove(\"focus\");\n  };\n\n  private onInput = (event: Event) => {\n    const items = [];\n    const value = this.normalize(this.input.value);\n    const options = this.list ? this.list.options : this.select.options;\n\n    if (value.length > 0) {\n      for (const option of options) {\n        if (!option.selected) {\n          const label = this.normalize(option.label);\n\n          if (label.includes(value)) {\n            const item = document.createElement(\"button\");\n\n            item.type = \"button\";\n            item.innerText = option.label;\n            item.dataset.value = option.value;\n            item.dataset.label = option.label;\n            item.classList.add(\"dropdown-item\");\n            item.addEventListener(\"click\", this.onItemClick);\n\n            items.push(item);\n          }\n        }\n      }\n    }\n\n    if (items.length === 0) {\n      this.dropdown.hide();\n      this.menu.replaceChildren();\n    } else {\n      items.sort((a, b) => a.dataset.label.localeCompare(b.dataset.label));\n      this.menu.replaceChildren(...items);\n      this.dropdown.show();\n    }\n  };\n\n  private onShowBsDropdown = (event: Event) => {\n    if (this.menu.children.length === 0) {\n      event.preventDefault();\n    }\n  };\n\n  private onShownBsDropdown = (event: Event) => {\n    this.menu.scroll(0, 0);\n  };\n\n  private onItemClick = (event: Event) => {\n    const button = event.target as HTMLElement;\n\n    const label = button.dataset.label;\n    const value = button.dataset.value;\n\n    this.setSelected(value);\n    this.addTag(label, value);\n    this.resetInput();\n    this.dispatchChanged();\n  };\n}\n"],"names":["Select","static","el","this","map","get","instance","set","constructor","element","mutable","count","getValue","toString","onClick","input","focus","onKeyDown","event","key","value","length","preventDefault","addItem","removeItem","nextItem","onFocusIn","classList","add","onFocusOut","remove","onInput","items","normalize","options","list","select","option","selected","label","includes","item","document","createElement","type","innerText","dataset","addEventListener","onItemClick","push","dropdown","hide","menu","replaceChildren","sort","a","b","localeCompare","show","onShowBsDropdown","children","onShownBsDropdown","scroll","button","target","setSelected","addTag","resetInput","dispatchChanged","querySelector","Dropdown","getOrCreateInstance","autocomplete","getElementById","Object","defineProperty","debounce","update","querySelectorAll","forEach","removeTag","selectedOptions","tag","insertBefore","dispatchEvent","CustomEvent","trim","toUpperCase","replace","Array","from","find","found","cloneNode","active","getActive","previousElementSibling","backward","next","nextElementSibling","scrollIntoView","block","lastElementChild","firstElementChild","cb","delay","timeout","args","clearTimeout","setTimeout","WeakMap"],"mappings":"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"}