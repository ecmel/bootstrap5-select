{"version":3,"file":"select.js","sources":["../select.ts"],"sourcesContent":["import { Dropdown } from \"bootstrap\";\n\nexport class Select {\n  private static map = new WeakMap<Element, Select>();\n\n  static getInstance(el: Element) {\n    return this.map.get(el);\n  }\n\n  static getOrCreateInstance(el: Element) {\n    let instance = this.map.get(el);\n\n    if (!instance) {\n      instance = new Select(el);\n    }\n\n    return instance;\n  }\n\n  private element: HTMLElement;\n  private input: HTMLInputElement;\n  private select: HTMLSelectElement;\n  private menu: HTMLElement;\n  private dropdown: Dropdown;\n  private mutable = false;\n  private count = 0;\n\n  constructor(element: Element) {\n    this.element = element as HTMLElement;\n    this.input = this.element.querySelector(\"input\");\n    this.select = this.element.querySelector(\"select\");\n    this.menu = this.element.querySelector(\".dropdown-menu\");\n    this.dropdown = Dropdown.getOrCreateInstance(this.input);\n\n    this.input.autocomplete = \"off\";\n\n    this.mutable =\n      this.element.dataset.mutable === \"\" ||\n      this.element.dataset.mutable === \"true\";\n\n    Object.defineProperty(this.element, \"value\", { get: this.getValue });\n\n    this.input.addEventListener(\"keydown\", this.onKeyDown);\n    this.input.addEventListener(\"input\", this.debounce(this.onInput));\n    this.input.addEventListener(\"focusin\", this.onFocusIn);\n    this.input.addEventListener(\"focusout\", this.onFocusOut);\n    this.input.addEventListener(\"show.bs.dropdown\", this.onShowBsDropdown);\n    this.input.addEventListener(\"shown.bs.dropdown\", this.onShownBsDropdown);\n    this.element.addEventListener(\"click\", this.onClick);\n\n    Select.map.set(this.element, this);\n\n    this.update();\n  }\n\n  update() {\n    this.element\n      .querySelectorAll(\".option\")\n      .forEach((el) => this.removeTag(el));\n\n    for (const option of this.select.selectedOptions) {\n      this.addTag(option.label, option.value);\n    }\n  }\n\n  private addTag(label: string, value = \"\") {\n    const tag = document.createElement(\"span\");\n\n    tag.classList.add(\"option\");\n\n    tag.innerText = label;\n    tag.dataset.label = label;\n    tag.dataset.value = value || label;\n\n    this.count++;\n    this.element.insertBefore(tag, this.input);\n  }\n\n  private removeTag(tag: Element) {\n    this.count--;\n    tag.remove();\n  }\n\n  private resetInput() {\n    this.input.value = \"\";\n    this.menu.replaceChildren();\n  }\n\n  private dispatchChanged() {\n    this.element.dispatchEvent(new CustomEvent(\"changed.bs5.select\"));\n    this.element.dispatchEvent(new CustomEvent(\"input\"));\n  }\n\n  private normalize(value: string) {\n    return value\n      .trim()\n      .toUpperCase()\n      .normalize(\"NFD\")\n      .replace(/[\\u0300-\\u036f]/g, \"\");\n  }\n\n  private setSelected(value: string, selected = true) {\n    const option = Array.from(this.select.options).find(\n      (option) => option.value === value\n    );\n\n    option.selected = selected;\n  }\n\n  private addItem() {\n    const active = this.getActive();\n\n    if (active) {\n      const label = active.dataset.label;\n      const value = active.dataset.value;\n\n      this.addTag(label, value);\n      this.setSelected(value);\n    } else if (this.mutable) {\n      const value = this.input.value;\n\n      const found = Array.from(this.select.options).find(\n        (option) => option.value.trim() === value.trim()\n      );\n\n      if (found) {\n        if (!found.selected) {\n          this.addTag(value);\n          this.setSelected(value);\n        }\n      } else {\n        const option = document.createElement(\"option\");\n\n        option.value = value;\n        option.label = value;\n\n        this.select.options.add(option);\n\n        this.addTag(value);\n        this.setSelected(value);\n      }\n    }\n\n    this.dispatchChanged();\n    this.resetInput();\n\n    this.dropdown.hide();\n  }\n\n  private removeItem() {\n    const tag = this.input.previousElementSibling as HTMLElement;\n\n    if (tag) {\n      this.removeTag(tag);\n      this.setSelected(tag.dataset.value, false);\n      this.dispatchChanged();\n    }\n  }\n\n  private nextItem(backward = false) {\n    const active = this.getActive();\n\n    if (active) {\n      active.classList.remove(\"active\");\n\n      const next = backward\n        ? active.previousElementSibling\n        : active.nextElementSibling;\n\n      if (next) {\n        next.classList.add(\"active\");\n        next.scrollIntoView({ block: \"nearest\" });\n        return;\n      }\n    }\n\n    const next = backward\n      ? this.menu.lastElementChild\n      : this.menu.firstElementChild;\n\n    if (next) {\n      next.classList.add(\"active\");\n      next.scrollIntoView({ block: \"nearest\" });\n    }\n  }\n\n  private getActive(): HTMLElement {\n    return this.menu.querySelector(\".active\");\n  }\n\n  private debounce(cb: Function, delay = 250) {\n    let timeout: any;\n\n    return (...args: any[]) => {\n      clearTimeout(timeout);\n      timeout = setTimeout(() => cb(...args), delay);\n    };\n  }\n\n  private getValue = () => {\n    return this.count === 0 ? \"\" : this.count.toString();\n  };\n\n  private onClick = () => {\n    this.input.focus();\n  };\n\n  private onKeyDown = (event: KeyboardEvent) => {\n    switch (event.key) {\n      case \"Enter\":\n        if (this.input.value.length !== 0) {\n          event.preventDefault();\n          this.addItem();\n        }\n        break;\n\n      case \"Backspace\":\n        if (this.input.value.length === 0) {\n          this.removeItem();\n        }\n        break;\n\n      case \"ArrowDown\":\n        this.nextItem();\n        break;\n\n      case \"ArrowUp\":\n        this.nextItem(true);\n        break;\n    }\n  };\n\n  private onFocusIn = () => {\n    this.element.classList.add(\"focus\");\n  };\n\n  private onFocusOut = () => {\n    this.element.classList.remove(\"focus\");\n  };\n\n  private onInput = (event: Event) => {\n    event.stopPropagation();\n\n    const items = [];\n    const value = this.normalize(this.input.value);\n\n    if (value.length > 0) {\n      for (const option of this.select.options) {\n        if (!option.selected) {\n          const label = this.normalize(option.label);\n\n          if (label.includes(value)) {\n            const item = document.createElement(\"button\");\n\n            item.type = \"button\";\n            item.innerText = option.label;\n            item.dataset.value = option.value;\n            item.dataset.label = option.label;\n            item.classList.add(\"dropdown-item\");\n            item.addEventListener(\"click\", this.onItemClick);\n\n            items.push(item);\n          }\n        }\n      }\n    }\n\n    if (items.length === 0) {\n      this.dropdown.hide();\n      this.menu.replaceChildren();\n    } else {\n      items.sort((a, b) => a.dataset.label.localeCompare(b.dataset.label));\n      this.menu.replaceChildren(...items);\n      this.dropdown.show();\n    }\n  };\n\n  private onShowBsDropdown = (event: Event) => {\n    if (this.menu.children.length === 0) {\n      event.preventDefault();\n    }\n  };\n\n  private onShownBsDropdown = (event: Event) => {\n    this.menu.scroll(0, 0);\n  };\n\n  private onItemClick = (event: Event) => {\n    const button = event.target as HTMLElement;\n\n    const label = button.dataset.label;\n    const value = button.dataset.value;\n\n    this.setSelected(value);\n    this.addTag(label, value);\n    this.resetInput();\n    this.dispatchChanged();\n  };\n}\n"],"names":["Select","static","el","this","map","get","instance","constructor","element","mutable","count","getValue","toString","onClick","input","focus","onKeyDown","event","key","value","length","preventDefault","addItem","removeItem","nextItem","onFocusIn","classList","add","onFocusOut","remove","onInput","stopPropagation","items","normalize","option","select","options","selected","label","includes","item","document","createElement","type","innerText","dataset","addEventListener","onItemClick","push","dropdown","hide","menu","replaceChildren","sort","a","b","localeCompare","show","onShowBsDropdown","children","onShownBsDropdown","scroll","button","target","setSelected","addTag","resetInput","dispatchChanged","querySelector","Dropdown","getOrCreateInstance","autocomplete","Object","defineProperty","debounce","set","update","querySelectorAll","forEach","removeTag","selectedOptions","tag","insertBefore","dispatchEvent","CustomEvent","trim","toUpperCase","replace","Array","from","find","active","getActive","found","previousElementSibling","backward","next","nextElementSibling","scrollIntoView","block","lastElementChild","firstElementChild","cb","delay","timeout","args","clearTimeout","setTimeout","WeakMap"],"mappings":"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"}